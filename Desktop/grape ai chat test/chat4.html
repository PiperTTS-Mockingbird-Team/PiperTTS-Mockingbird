<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epictetus AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
      
      * { font-family: 'Inter', sans-serif; }
      
      body {
        background: #020617;
        min-height: 100vh;
      }
      
      @keyframes spin { to { transform: rotate(360deg); } }
      .spinner { animation: spin 1s linear infinite; }
      
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      .fade-in { animation: fadeIn 0.8s ease-out forwards; }
      
      .preserve-spin {
        will-change: transform, opacity;
        transform: translateZ(0);
      }
      
      .message-enter {
        animation: slideUp 0.4s ease-out;
      }
      
      @keyframes slideUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      .typing-indicator span {
        display: inline-block;
        width: 8px;
        height: 8px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        border-radius: 50%;
        animation: typing 1.4s infinite ease-in-out both;
        margin: 0 3px;
      }
      .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
      .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
      
      @keyframes typing {
        0%, 80%, 100% { transform: scale(0); opacity: 0.3; }
        40% { transform: scale(1); opacity: 1; }
      }
      
      #status.loading::before {
        content: "";
        display: inline-block;
        width: 10px;
        height: 10px;
        margin-right: 8px;
        vertical-align: -1px;
        border: 2px solid rgba(255,255,255,0.3);
        border-top-color: #667eea;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }
      
      .pulse-dot {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }
      
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }

      /* Neural Mesh Canvas */
      #neuralCanvas {
        position: fixed;
        inset: 0;
        pointer-events: none;
        opacity: 0.4;
        z-index: 0;
      }

      /* Glow effect for input */
      .input-glow {
        position: absolute;
        inset: -1px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        border-radius: 2rem;
        opacity: 0.2;
        filter: blur(8px);
        transition: opacity 0.3s;
      }

      .input-container:focus-within .input-glow {
        opacity: 0.4;
      }

      #history::-webkit-scrollbar {
        width: 6px;
      }
      
      #history::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
      }
      
      #history::-webkit-scrollbar-thumb {
        background: rgba(102, 126, 234, 0.5);
        border-radius: 10px;
      }
      
      #history::-webkit-scrollbar-thumb:hover {
        background: rgba(102, 126, 234, 0.7);
      }
    </style>
  </head>
  <body class="selection:bg-blue-500/30 fade-in">
    <canvas id="neuralCanvas"></canvas>
    
    <div class="flex h-screen text-slate-100 overflow-hidden">
      <!-- Main Chat Area -->
      <main class="flex-1 flex flex-col relative z-10 max-w-5xl mx-auto w-full">
        <!-- Header -->
        <header class="absolute top-0 left-0 w-full p-6 bg-transparent z-20">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
              <svg viewBox="0 0 1024 1024" class="w-24 h-24 text-white" xmlns="http://www.w3.org/2000/svg" fill="currentColor" aria-hidden="true">
                <path fill-rule="evenodd" d="M490.5 268.684c-5.57.483-23.982 3.267-29.998 4.535-4.514.951-4.764 1.14-2.581 1.948 1.503.556 2.064 1.248 1.481 1.831-1.148 1.148-5.596.125-4.832-1.112 2.415-3.906-30.355 7.409-51.39 17.745-14.674 7.21-36.445 21.131-35.483 22.688.337.545.121.686-.48.315-1.079-.667-15.996 11.2-21.62 17.199l-2.903 3.096 5.838 6.786c3.21 3.732 6.172 7.18 6.581 7.663.616.728 12.75-8.729 28.637-22.318 1.788-1.529 3.25-2.602 3.25-2.385s.913-.093 2.028-.69 1.721-1.582 1.345-2.19c-.408-.661-.225-.821.459-.399.628.388 4.422-1.287 8.433-3.721 15.216-9.237 34.618-17.63 52.49-22.706 5.544-1.575 7.843-2.638 7-3.238-.797-.567-.263-.677 1.464-.301 1.495.326 4.761.135 7.256-.424 20.648-4.628 54.491-5.818 74.525-2.621 11.829 1.888 24.371 4.727 33.986 7.694 4.121 1.272 6.614 1.622 6.834.962.191-.573 1.322-1.015 2.513-.982 1.922.052 1.98.186.514 1.184-1.374.934.062 1.826 8.5 5.275 49.539 20.253 88.686 55.473 114.675 103.17 1.854 3.403 3.802 5.921 4.329 5.595s.646-.087.265.53 1.309 5.749 3.757 11.404c19.56 45.19 23.296 95.087 10.653 142.283-1.621 6.05-4.082 14.318-5.469 18.374s-2.233 7.88-1.879 8.5c.353.619.265.783-.197.363s-3.379 4.53-6.482 11c-9.307 19.405-19.758 35.521-33.665 51.915-3.32 3.913-5.137 6.87-4.686 7.621.654 1.087 10.102 14.451 11.119 15.726.468.587 5.509-5.043 15.666-17.499 8.539-10.471 18.172-25.13 25.147-38.265 4.21-7.927 4.703-9.421 3.42-10.344-1.295-.932-1.276-1.009.137-.56 1.237.392 2.374-1.109 4.662-6.156 3.745-8.262 9.629-24.159 11.169-30.175.633-2.475 1.397-5.344 1.699-6.375.403-1.381.19-1.665-.81-1.078-.746.438-.541-.135.457-1.274 1.205-1.377 2.673-6.887 4.374-16.422 2.249-12.61 2.575-17.323 2.686-38.851.133-25.869-.559-33.306-5.022-54-3.755-17.412-7.343-27.937-9.276-27.215-1.287.481-1.354.316-.368-.9 1.314-1.619.616-6.203-.81-5.322-.481.298-.638-.077-.348-.833.601-1.566-4.638-14.249-10.694-25.89-3.754-7.215-4.224-7.735-5.534-6.113-1.3 1.609-1.33 1.562-.327-.505.956-1.97.423-3.407-3.932-10.618-14.088-23.324-37.029-48.359-60.497-66.022-9.371-7.052-28.576-18.694-29.697-18.001-.478.295-.869.059-.869-.525 0-1.232-22.071-12.014-29.594-14.458-2.802-.91-5.952-1.375-7-1.032-1.414.462-1.554.371-.542-.351 3.126-2.232-27.525-9.917-50.864-12.755-10.268-1.248-38.897-1.697-49.5-.776M462 291.692c0 .962.785 1.158 2.75.686 3.769-.904 3.8-1.07.296-1.585-2.107-.309-3.046-.032-3.046.899M630 301c0 .55.45 1 1 1s1-.45 1-1-.45-1-1-1-1 .45-1 1m-308.104 57.297c-20.647 25.645-36.852 57.206-45.521 88.657-3.736 13.558-7.72 34.703-6.928 36.77.27.702 1.978 1.276 3.797 1.276 3.55 0 24.954 3.623 41.256 6.984 26.884 5.542 54.237 14.381 71.943 23.249 20.402 10.217 31.815 19.641 39.388 32.524 3.289 5.593 5.115 7.628 7.968 8.875 6.74 2.946 39.689 13.162 40.346 12.509.354-.353 2.749-9.253 5.321-19.778l4.676-19.137-3.571-11.278c-1.964-6.203-3.571-11.668-3.571-12.144s3.262 1.326 7.25 4.004c12.024 8.075 34.922 22.353 35.279 21.997.644-.645 10.471-41.544 10.43-43.413-.023-1.041-1.935-6.392-4.25-11.892l-4.209-10-24-11.829c-21.508-10.601-24.882-11.963-32.5-13.12-15.342-2.33-33.736-9.678-51.612-20.62-30.084-18.413-65.185-47.472-78.888-65.308-2.75-3.579-5.225-6.513-5.5-6.518-.275-.006-3.472 3.681-7.104 8.192m254.996 94.453c-4.643 4.954-17.103 20.075-19.201 23.3-1.502 2.308-1.513 2.759-.118 4.75 2.618 3.739 4.965 2.673 11.112-5.05 3.174-3.988 8.071-9.95 10.881-13.25 6.13-7.196 6.733-8.627 4.802-11.385-2.076-2.964-3.448-2.664-7.476 1.635m6.184 36.859C567.327 492.095 565 492.918 565 496c0 4.379 2.107 4.529 21.826 1.549 10.271-1.553 19.259-3.285 19.975-3.85.715-.565 1.165-2.191 1-3.613-.271-2.325-.756-2.602-4.801-2.749-2.475-.089-11.441.933-19.924 2.272m-314.78 31.141c1.5 42.637 14.178 83.851 36.739 119.434 11.144 17.575 18.424 26.467 35.874 43.816 16.371 16.276 27.539 25.499 30.881 25.501.94.001 1.766.564 1.835 1.25.256 2.557.428 2.714 1.375 1.249.839-1.299.971-1.277.985.161.027 2.97 34.582 22.843 37.059 21.312.526-.325.956-.176.956.331 0 1.24 9.204 5.205 22 9.478 12.991 4.338 17 5.233 17 3.797 0-.593.436-1.079.969-1.079s.738.599.457 1.331c-.357.931 1.082 1.679 4.782 2.484 22.645 4.928 48.511 6.918 69.444 5.342 19.088-1.438 42.424-5.308 42.199-6.999-.25-1.876.283-2.494 1.074-1.245.747 1.18 2.511.892 10.734-1.756 5.413-1.742 11.554-3.953 13.648-4.912l3.807-1.745-6.146-8.654-6.146-8.654-9.743 3.281C560.112 730.524 535.608 735 520.449 735c-3.547 0-6.449.424-6.449.943s.804.787 1.786.598c2.068-.398 2.565 3.11.551 3.883-.754.29-1.019-.09-.679-.975.306-.797.058-1.449-.551-1.449s-1.107.482-1.107 1.071c0 .59-.675.397-1.5-.428-1.774-1.774-1.991-3.065-.345-2.048.715.443.883.275.44-.44-.437-.709-3.685-1.161-8.404-1.171-6.986-.014-31.191-2.942-37.581-4.546-1.697-.426-2.61-.246-2.61.513 0 .642.419.908.931.592s1.205-.131 1.541.411c.889 1.44-4.399 2.519-5.745 1.173-.836-.836-.802-1.127.132-1.127.692 0 .981-.45.641-1s-.029-1.028.691-1.061c.72-.034-3.641-1.56-9.691-3.392s-12.267-3.829-13.815-4.438c-3.468-1.366-3.972-1.383-3.185-.109.34.55.141 1-.441 1s-1.059-.675-1.059-1.5-.562-1.501-1.25-1.501c-2.473-.002-33.433-15.985-41.75-21.554-4.675-3.129-9.038-5.71-9.694-5.734s-1.107-.344-1-.711c.106-.366-3.406-3.546-7.806-7.065-16.834-13.466-35.312-33.885-46.999-51.935-23.28-35.953-35.097-72.568-36.909-114.356-.259-5.971-.708-11.093-.998-11.383-.523-.523-15.811-3.203-18.49-3.241-1.164-.017-1.299 2.773-.808 16.73m276.286-5.5c-.195.688-1.763 9.674-3.486 19.97l-3.131 18.719 7.018 11.463c3.859 6.305 7.017 11.719 7.017 12.031 0 1.207-3.466.302-29.786-7.776l-27.182-8.344-.502 3.094c-.883 5.439-3.53 33.473-3.53 37.387 0 3.074.52 4.082 2.799 5.428 5.482 3.238 26.883 19.25 38.201 28.581 13.68 11.278 47.128 44.63 58.867 58.697 4.589 5.5 12.615 15.962 17.836 23.25S618.492 731 618.854 731s5.156-2.532 10.653-5.627c12.928-7.279 31.528-19.918 38.398-26.092l5.406-4.857-10.526-13.962c-21.466-28.472-44.623-67.185-67.767-113.293-10.639-21.193-11.271-22.186-17.774-27.922-7.037-6.206-31.058-25.247-31.851-25.247-.251 0-.615.563-.811 1.25M433.5 588.716c-8.25 1.917-15.585 3.963-16.301 4.549-.715.585-1.165 2.227-1 3.649.436 3.747 3.534 3.653 22.801-.693 15.172-3.421 16.526-3.907 16.827-6.026.441-3.111-1.51-5.22-4.699-5.079-1.446.064-9.378 1.684-17.628 3.6m26.228 12.699c-.778.778-3.567 4.941-6.197 9.25s-6.668 10.76-8.973 14.335-4.498 7.32-4.871 8.322c-.993 2.663 1.008 5.678 3.769 5.678 1.99 0 4.049-2.62 12.423-15.81 5.521-8.695 10.316-16.535 10.656-17.422 1.585-4.129-3.67-7.49-6.807-4.353M356.357 673.5c.825.825 1.812 1.5 2.194 1.5s.134-.675-.551-1.5-1.672-1.5-2.194-1.5-.274.675.551 1.5m.143 3.5c.34.55 1.266 1 2.059 1s1.441-.45 1.441-1-.927-1-2.059-1-1.781.45-1.441 1m81.5 47c0 .55.477 1 1.059 1s.781-.45.441-1-.816-1-1.059-1-.441.45-.441 1m68 12.786c0 .432.867.785 1.927.785 1.059 0 1.708-.353 1.441-.785-.268-.432-1.134-.786-1.927-.786s-1.441.354-1.441.786m13.564.921c-.542 1.425-.428 1.54.56.56.684-.679.991-1.486.683-1.793-.308-.308-.867.247-1.243 1.233"/>
              </svg>
              <div class="flex flex-col">
                <h1 class="text-2xl font-bold text-white tracking-tight">Epictetus AI</h1>
                <span class="text-xs text-slate-500 font-mono">v2.0</span>
              </div>
            </div>
            
            <!-- System Requirements Info -->
            <div class="group relative">
              <div class="p-2 cursor-help text-slate-400 hover:text-white transition-colors">
                <i data-lucide="info" class="w-5 h-5"></i>
              </div>
              <div class="absolute right-0 top-full mt-2 w-64 bg-[#0f172a] border border-white/10 rounded-xl p-4 shadow-2xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-50">
                <h3 class="text-sm font-bold text-white mb-3 flex items-center gap-2">
                  <i data-lucide="cpu" class="w-4 h-4 text-blue-400"></i>
                  System Requirements
                </h3>
                <div class="space-y-2 text-xs text-slate-300">
                  <div class="flex justify-between">
                    <span class="text-slate-400">RAM:</span>
                    <span class="font-medium">4GB minimum</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-slate-400">CPU:</span>
                    <span class="font-medium">Modern multi-core</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-slate-400">Storage:</span>
                    <span class="font-medium">~300MB download</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-slate-400">Browser:</span>
                    <span class="font-medium">Chrome/Edge 90+</span>
                  </div>
                </div>
                <div class="mt-3 text-sm text-slate-300 leading-relaxed">
                  This is a test to see if I could give someone a local AI chatbot just by sharing an HTML file with them. 
                </div>
                <div class="mt-3 pt-3 text-[10px] text-slate-400">
                  Model runs entirely in your browser using WebAssembly
                </div>
              </div>
            </div>
          </div>
        </header>

        <!-- Chat History -->
        <div id="history" class="flex-1 overflow-y-auto px-6 pt-24 pb-8 space-y-8">
          <!-- Empty state -->
          <div id="emptyState" class="h-full flex flex-col items-center justify-center text-center max-w-xl mx-auto space-y-6">
            <h2 class="text-3xl font-bold tracking-tight text-white">Experience AI that runs entirely in your browser, ensuring total privacy.</h2>
            <!-- moved into System Requirements info toast -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 w-full mt-8">
              <button class="suggestion p-4 rounded-2xl bg-white/5 border border-white/10 text-sm hover:bg-white/10 transition-all text-left group flex items-center justify-between hover:border-blue-500/30" data-text="Write a short poem">
                Write a short poem
                <i data-lucide="chevron-right" class="w-4 h-4 opacity-0 group-hover:opacity-100 transition-all text-blue-400"></i>
              </button>
              <button class="suggestion p-4 rounded-2xl bg-white/5 border border-white/10 text-sm hover:bg-white/10 transition-all text-left group flex items-center justify-between hover:border-blue-500/30" data-text="Tell me a fun fact">
                Tell me a fun fact
                <i data-lucide="chevron-right" class="w-4 h-4 opacity-0 group-hover:opacity-100 transition-all text-blue-400"></i>
              </button>
              <button class="suggestion p-4 rounded-2xl bg-white/5 border border-white/10 text-sm hover:bg-white/10 transition-all text-left group flex items-center justify-between hover:border-blue-500/30" data-text="Suggest 5 creative project ideas">
                Suggest 5 creative project ideas
                <i data-lucide="chevron-right" class="w-4 h-4 opacity-0 group-hover:opacity-100 transition-all text-blue-400"></i>
              </button>
              <button class="suggestion p-4 rounded-2xl bg-white/5 border border-white/10 text-sm hover:bg-wheel/10 transition-all text-left group flex items-center justify-between hover:border-blue-500/30" data-text="Help me brainstorm a story">
                Help me brainstorm a story
                <i data-lucide="chevron-right" class="w-4 h-4 opacity-0 group-hover:opacity-100 transition-all text-blue-400"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Input Area -->
        <div class="p-6 pb-8 bg-gradient-to-t from-[#020617] via-[#020617]/90 to-transparent">
          <div class="max-w-4xl mx-auto relative input-container">
            <div class="input-glow"></div>
            <div class="relative bg-[#0f172a]/80 backdrop-blur-2xl border border-white/10 rounded-[2rem] shadow-2xl overflow-hidden flex items-end">
              <textarea
                id="msg"
                placeholder="Ask Epictetus AI..."
                disabled
                class="w-full bg-transparent border-none focus:ring-0 text-white placeholder-slate-500 py-6 px-8 resize-none max-h-48 min-h-[72px] focus:outline-none"
                rows="1"
              ></textarea>
              <div class="p-4 flex gap-2">
                <button 
                  id="clear"
                  class="w-12 h-12 rounded-2xl bg-white/5 border border-white/10 text-slate-400 hover:bg-white/10 hover:text-white transition-all flex items-center justify-center"
                >
                  <i data-lucide="trash-2" class="w-5 h-5"></i>
                </button>
                <button 
                  id="send"
                  disabled
                  class="w-12 h-12 rounded-2xl bg-white text-black flex items-center justify-center hover:scale-105 disabled:opacity-30 disabled:hover:scale-100 transition-all shadow-xl shadow-white/10"
                >
                  <i data-lucide="send" class="w-5 h-5"></i>
                </button>
              </div>
            </div>
          </div>
          
          <!-- Status Bar -->
          <div class="max-w-4xl mx-auto mt-3 flex items-center justify-between">
            <div id="status" class="text-xs text-slate-400 flex items-center">
              <span id="statusText">Initializing neural engine...</span>
            </div>
            <p class="text-[10px] text-slate-600 tracking-wider uppercase font-bold opacity-50">
              Qwen1.5-0.5B • Local
            </p>
          </div>
        </div>
      </main>
    </div>

    <script type="module">
      // Initialize Lucide icons
      lucide.createIcons();

      const historyBox = document.getElementById("history");
      const emptyState = document.getElementById("emptyState");
      const statusContainer = document.getElementById("status");
      const statusText = document.getElementById("statusText");
      const msg = document.getElementById("msg");
      const sendBtn = document.getElementById("send");
      const clearBtn = document.getElementById("clear");

      let generator;
      const MODEL_NAME = "Xenova/Qwen1.5-0.5B-Chat";

      // Neural Mesh Animation
      const canvas = document.getElementById('neuralCanvas');
      const ctx = canvas.getContext('2d');
      let particles = [];

      function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      }

      class Particle {
        constructor() { this.reset(); }
        reset() {
          this.x = Math.random() * canvas.width;
          this.y = Math.random() * canvas.height;
          this.vx = (Math.random() - 0.5) * 0.3;
          this.vy = (Math.random() - 0.5) * 0.3;
          this.radius = Math.random() * 1.2;
        }
        update() {
          this.x += this.vx;
          this.y += this.vy;
          if (this.x < 0 || this.x > canvas.width) this.vx *= -1;
          if (this.y < 0 || this.y > canvas.height) this.vy *= -1;
        }
        draw() {
          ctx.beginPath();
          ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
          ctx.fillStyle = 'rgba(147, 197, 253, 0.3)';
          ctx.fill();
        }
      }

      function initParticles() {
        resizeCanvas();
        particles = Array.from({ length: 40 }, () => new Particle());
      }

      function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        particles.forEach(p => { p.update(); p.draw(); });
        requestAnimationFrame(animate);
      }

      window.addEventListener('resize', resizeCanvas);
      initParticles();
      animate();

      // Handle suggestion clicks
      document.querySelectorAll('.suggestion').forEach(btn => {
        btn.addEventListener('click', () => {
          msg.value = btn.dataset.text;
          msg.focus();
        });
      });

      // Initialize AI Model
      async function initModel() {
        try {
          statusContainer.classList.add('loading');
          statusText.textContent = "Loading neural weights (approx 300MB)...";
          
          const { pipeline, env } = await import('https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2');
          env.allowLocalModels = false;

          generator = await pipeline("text-generation", MODEL_NAME, {
            dtype: 'q4' 
          });
          
          statusContainer.classList.remove('loading');
          statusText.textContent = "Ready. Type your message above.";
          msg.disabled = false;
          sendBtn.disabled = false;
          msg.focus();
        } catch (e) {
          statusContainer.classList.remove('loading');
          statusText.textContent = "Error: " + e.message;
          console.error(e);
          appendMessage('system', `⚠️ Initialization Error: ${e.message}. \n\nTry running this on a local server (e.g., "python -m http.server") instead of opening the file directly.`);
        }
      }

      initModel();

      function appendMessage(role, text) {
        if (emptyState.style.display !== 'none') {
          emptyState.style.display = 'none';
        }

        const div = document.createElement('div');
        div.className = 'message-enter';
        
        const isUser = role === 'user';
        const isSystem = role === 'system';
        
        if (isSystem) {
          div.innerHTML = `
            <div class="flex items-start gap-3 p-4 rounded-2xl bg-amber-500/10 border border-amber-500/20">
              <i data-lucide="alert-triangle" class="w-5 h-5 text-amber-400 mt-0.5 flex-shrink-0"></i>
              <p class="text-sm text-amber-200 leading-relaxed">${text}</p>
            </div>
          `;
        } else {
          div.innerHTML = `
            <div class="flex ${isUser ? 'justify-end' : 'justify-start'} gap-4 group">
              ${isUser ? `
                <button class="copy-btn opacity-0 group-hover:opacity-100 transition-all flex-shrink-0" data-text="${text.replace(/"/g, '&quot;')}">
                  <i data-lucide="copy" class="w-4 h-4 text-slate-400 hover:text-slate-200 transition-colors"></i>
                </button>
              ` : ''}
              ${!isUser ? `
                <div class="w-8 h-8 rounded-xl bg-gradient-to-br from-purple-600 to-blue-600 p-[2px] flex-shrink-0">
                  <div class="w-full h-full bg-[#020617] rounded-xl flex items-center justify-center">
                    <i data-lucide="bot" class="w-4 h-4 text-purple-400"></i>
                  </div>
                </div>
              ` : ''}
              <div class="max-w-[85%] md:max-w-[75%] rounded-2xl px-5 py-3 shadow-xl ${
                isUser 
                  ? 'bg-gradient-to-br from-blue-600 to-blue-700 text-white rounded-tr-md' 
                  : 'bg-white/5 border border-white/10 backdrop-blur-md text-slate-100 rounded-tl-md'
              }">
                <p class="text-[15px] leading-relaxed whitespace-pre-wrap">${text}</p>
              </div>
              ${isUser ? `
                <div class="w-8 h-8 rounded-xl bg-white/5 border border-white/10 flex-shrink-0 flex items-center justify-center">
                  <i data-lucide="user" class="w-4 h-4 text-slate-400"></i>
                </div>
              ` : ''}
              ${!isUser ? `
                <button class="copy-btn opacity-0 group-hover:opacity-100 transition-all flex-shrink-0" data-text="${text.replace(/"/g, '&quot;')}">
                  <i data-lucide="copy" class="w-4 h-4 text-slate-400 hover:text-slate-200 transition-colors"></i>
                </button>
              ` : ''}
            </div>
          `;
        }
        
        historyBox.appendChild(div);
        lucide.createIcons();
        historyBox.scrollTop = historyBox.scrollHeight;
        return div;
      }

      function showTyping() {
        if (emptyState.style.display !== 'none') {
          emptyState.style.display = 'none';
        }

        const div = document.createElement('div');
        div.id = 'typing-indicator';
        div.className = 'message-enter';
        div.innerHTML = `
          <div class="flex justify-start gap-4">
            <div class="w-8 h-8 rounded-xl bg-gradient-to-br from-purple-600 to-blue-600 p-[2px] flex-shrink-0">
              <div class="w-full h-full bg-[#020617] rounded-xl flex items-center justify-center">
                <i data-lucide="bot" class="w-4 h-4 text-purple-400"></i>
              </div>
            </div>
            <div class="bg-white/5 border border-white/10 backdrop-blur-md rounded-2xl rounded-tl-md px-5 py-4">
              <div class="typing-indicator flex items-center h-3">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>
          </div>
        `;
        historyBox.appendChild(div);
        lucide.createIcons();
        historyBox.scrollTop = historyBox.scrollHeight;
      }

      function removeTyping() {
        const typing = document.getElementById('typing-indicator');
        if (typing) typing.remove();
      }

      function clearChat() {
        historyBox.innerHTML = "";
        emptyState.style.display = 'flex';
        statusText.textContent = "Ready. Type your message above.";
        msg.value = "";
        msg.focus();
        lucide.createIcons();
      }

      async function handleSend() {
        const text = msg.value.trim();
        if (!text || !generator) return;

        appendMessage('user', text);
        msg.value = "";
        msg.disabled = true;
        sendBtn.disabled = true;
        
        showTyping();
        
        statusContainer.classList.add('loading');
        statusText.textContent = "Thinking...";

        await new Promise(resolve => setTimeout(resolve, 50));

        try {
          const prompt = `<|im_start|>system\nYou are a helpful assistant.<|im_end|>\n<|im_start|>user\n${text}<|im_end|>\n<|im_start|>assistant\n`;
          
          const result = await generator(prompt, {
            max_new_tokens: 256,
            temperature: 0.7,
            do_sample: true,
            top_p: 0.9,
            repetition_penalty: 1.1,
            return_full_text: false
          });

          let cleanOutput = result[0].generated_text;
          
          if (cleanOutput.includes("<|im_start|>assistant\n")) {
            cleanOutput = cleanOutput.split("<|im_start|>assistant\n")[1];
          }
          cleanOutput = cleanOutput.replace("<|im_end|>", "").trim();
          
          if (!cleanOutput) cleanOutput = "I couldn't generate a response.";
          
          removeTyping();
          appendMessage('ai', cleanOutput);

        } catch (e) {
          removeTyping();
          appendMessage('system', '⚠️ Error: ' + e.message);
        } finally {
          statusContainer.classList.remove('loading');
          statusText.textContent = "Ready.";
          msg.disabled = false;
          sendBtn.disabled = false;
          msg.focus();
        }
      }

      // Copy button functionality
      historyBox.addEventListener('click', (e) => {
        const copyBtn = e.target.closest('.copy-btn');
        if (copyBtn) {
          const text = copyBtn.dataset.text;
          navigator.clipboard.writeText(text).then(() => {
            // Store original HTML and replace with checkmark
            const originalHTML = copyBtn.innerHTML;
            copyBtn.innerHTML = '<i data-lucide="check" class="w-4 h-4 text-slate-400"></i>';
            lucide.createIcons();
            
            // Change back after 2 seconds
            setTimeout(() => {
              copyBtn.innerHTML = originalHTML;
              lucide.createIcons();
            }, 2000);
          }).catch(err => {
            console.error('Copy failed:', err);
          });
        }
      });

      sendBtn.onclick = handleSend;
      clearBtn.onclick = clearChat;
      msg.onkeydown = (e) => { 
        if (e.key === 'Enter' && !e.shiftKey) { 
          e.preventDefault(); 
          handleSend(); 
        } 
      };
    </script>
  </body>
</html>